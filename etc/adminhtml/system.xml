<?xml version="1.0"?>
<config xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
        xsi:noNamespaceSchemaLocation="urn:magento:module:Magento_Config:etc/system_file.xsd">
    <system>
        <tab id="magezero" translate="label" sortOrder="500">
            <label>MageZero</label>
        </tab>

        <section id="magezero" translate="label" sortOrder="10" showInDefault="1" showInWebsite="0" showInStore="0">
            <label>MageZero Settings</label>
            <tab>magezero</tab>
            <resource>MageZero_OpensearchObservability::config</resource>

            <group id="observability" translate="label comment" sortOrder="40" showInDefault="1" showInWebsite="0" showInStore="0">
                <label>Observability Settings</label>
                <comment><![CDATA[OpenSearch observability integration options for Datadog tracing hooks and optional log streaming.]]></comment>

                <field id="apm_enabled" translate="label comment" type="select" sortOrder="10" showInDefault="1" showInWebsite="0" showInStore="0">
                    <label>Enable Datadog Custom Spans</label>
                    <source_model>Magento\Config\Model\Config\Source\Yesno</source_model>
                    <comment>Disabled by default. Requires ddtrace extension and `DD_*` runtime variables.</comment>
                </field>

                <field id="apm_service_name" translate="label comment" type="text" sortOrder="20" showInDefault="1" showInWebsite="0" showInStore="0">
                    <label>Trace Service Name</label>
                    <comment>Optional override. If empty, hostname/request host fallback is used.</comment>
                    <depends>
                        <field id="apm_enabled">1</field>
                    </depends>
                </field>

                <field id="apm_environment" translate="label comment" type="text" sortOrder="30" showInDefault="1" showInWebsite="0" showInStore="0">
                    <label>Trace Environment</label>
                    <comment>Example: production, staging, development.</comment>
                    <depends>
                        <field id="apm_enabled">1</field>
                    </depends>
                </field>

                <field id="apm_transaction_sample_rate" translate="label comment" type="text" sortOrder="40" showInDefault="1" showInWebsite="0" showInStore="0">
                    <label>Trace Sample Rate</label>
                    <comment>Decimal 0..1. Used to set Datadog tracer sample rate at runtime.</comment>
                    <depends>
                        <field id="apm_enabled">1</field>
                    </depends>
                </field>

                <field id="apm_span_events_enabled" translate="label comment" type="select" sortOrder="50" showInDefault="1" showInWebsite="0" showInStore="0">
                    <label>Span Event Dispatch</label>
                    <source_model>Magento\Config\Model\Config\Source\Yesno</source_model>
                    <comment>Capture `Magento\Framework\Event\Manager::dispatch` spans with event metadata.</comment>
                    <depends>
                        <field id="apm_enabled">1</field>
                    </depends>
                </field>

                <field id="apm_span_layout_enabled" translate="label comment" type="select" sortOrder="60" showInDefault="1" showInWebsite="0" showInStore="0">
                    <label>Span Layout Rendering</label>
                    <source_model>Magento\Config\Model\Config\Source\Yesno</source_model>
                    <comment>Capture `Magento\Framework\View\Layout::renderElement` spans.</comment>
                    <depends>
                        <field id="apm_enabled">1</field>
                    </depends>
                </field>

                <field id="apm_span_plugins_enabled" translate="label comment" type="select" sortOrder="70" showInDefault="1" showInWebsite="0" showInStore="0">
                    <label>Span Plugin Resolution</label>
                    <source_model>Magento\Config\Model\Config\Source\Yesno</source_model>
                    <comment>Capture plugin lookup spans. Disabled by default due volume overhead.</comment>
                    <depends>
                        <field id="apm_enabled">1</field>
                    </depends>
                </field>

                <field id="apm_span_di_enabled" translate="label comment" type="select" sortOrder="80" showInDefault="1" showInWebsite="0" showInStore="0">
                    <label>Span DI Object Manager</label>
                    <source_model>Magento\Config\Model\Config\Source\Yesno</source_model>
                    <comment>Capture ObjectManager `create/get` spans. Disabled by default due high cardinality.</comment>
                    <depends>
                        <field id="apm_enabled">1</field>
                    </depends>
                </field>

                <field id="log_stream_enabled" translate="label comment" type="select" sortOrder="100" showInDefault="1" showInWebsite="0" showInStore="0">
                    <label>Enable Log Streaming</label>
                    <source_model>Magento\Config\Model\Config\Source\Yesno</source_model>
                    <comment>Disabled by default. When enabled, selected Magento logs are mirrored as structured JSON.</comment>
                </field>

                <field id="log_stream_transport" translate="label comment" type="select" sortOrder="110" showInDefault="1" showInWebsite="0" showInStore="0">
                    <label>Log Transport</label>
                    <source_model>MageZero\OpensearchObservability\Model\Config\Source\LogTransport</source_model>
                    <comment>Choose STDERR (collector-managed) or direct HTTP shipping.</comment>
                    <depends>
                        <field id="log_stream_enabled">1</field>
                    </depends>
                </field>

                <field id="log_stream_min_level" translate="label comment" type="select" sortOrder="120" showInDefault="1" showInWebsite="0" showInStore="0">
                    <label>Log Stream Minimum Level</label>
                    <source_model>MageZero\OpensearchObservability\Model\Config\Source\LogLevel</source_model>
                    <comment>Records below this level are not mirrored.</comment>
                    <depends>
                        <field id="log_stream_enabled">1</field>
                    </depends>
                </field>

                <field id="log_stream_direct_url" translate="label comment" type="text" sortOrder="130" showInDefault="1" showInWebsite="0" showInStore="0">
                    <label>Direct Log Endpoint Base URL</label>
                    <comment>Example: https://opensearch.example.com:9200</comment>
                    <depends>
                        <field id="log_stream_enabled">1</field>
                        <field id="log_stream_transport">direct</field>
                    </depends>
                </field>

                <field id="log_stream_direct_index" translate="label comment" type="text" sortOrder="140" showInDefault="1" showInWebsite="0" showInStore="0">
                    <label>Direct Log Index</label>
                    <comment>Target OpenSearch/Elasticsearch index name for logs.</comment>
                    <depends>
                        <field id="log_stream_enabled">1</field>
                        <field id="log_stream_transport">direct</field>
                    </depends>
                </field>

                <field id="log_stream_direct_api_key" translate="label comment" type="obscure" sortOrder="150" showInDefault="1" showInWebsite="0" showInStore="0">
                    <label>Direct Log API Key (Optional)</label>
                    <backend_model>Magento\Config\Model\Config\Backend\Encrypted</backend_model>
                    <comment>If set, sent as Authorization: ApiKey ... and takes precedence over username/password.</comment>
                    <depends>
                        <field id="log_stream_enabled">1</field>
                        <field id="log_stream_transport">direct</field>
                    </depends>
                </field>

                <field id="log_stream_direct_username" translate="label comment" type="text" sortOrder="160" showInDefault="1" showInWebsite="0" showInStore="0">
                    <label>Direct Log Username (Optional)</label>
                    <comment>Used only when API key is empty.</comment>
                    <depends>
                        <field id="log_stream_enabled">1</field>
                        <field id="log_stream_transport">direct</field>
                    </depends>
                </field>

                <field id="log_stream_direct_password" translate="label comment" type="obscure" sortOrder="170" showInDefault="1" showInWebsite="0" showInStore="0">
                    <label>Direct Log Password (Optional)</label>
                    <backend_model>Magento\Config\Model\Config\Backend\Encrypted</backend_model>
                    <comment>Used only when API key is empty and username is set.</comment>
                    <depends>
                        <field id="log_stream_enabled">1</field>
                        <field id="log_stream_transport">direct</field>
                    </depends>
                </field>

                <field id="log_stream_direct_timeout_ms" translate="label comment" type="text" sortOrder="180" showInDefault="1" showInWebsite="0" showInStore="0">
                    <label>Direct Log Timeout (ms)</label>
                    <comment>Fail-open timeout for each direct log request (default 500).</comment>
                    <depends>
                        <field id="log_stream_enabled">1</field>
                        <field id="log_stream_transport">direct</field>
                    </depends>
                </field>

                <field id="log_stream_direct_verify_tls" translate="label comment" type="select" sortOrder="190" showInDefault="1" showInWebsite="0" showInStore="0">
                    <label>Verify TLS Certificates</label>
                    <source_model>Magento\Config\Model\Config\Source\Yesno</source_model>
                    <comment>Disable only for controlled development environments using self-signed certificates.</comment>
                    <depends>
                        <field id="log_stream_enabled">1</field>
                        <field id="log_stream_transport">direct</field>
                    </depends>
                </field>
            </group>
        </section>
    </system>
</config>
